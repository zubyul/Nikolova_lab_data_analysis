---
title: "compute-DLPFC_PRS"
author: "Yuliya Zubak"
date: "22/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r}
### adapted from prediXcan_script_metaA_v7.R

library(RSQLite)
setwd('/Users/Administrator/Desktop/R/YZ-20191122T154314Z-001/YZ')

### step 1: read in predicted expression file 
### generated by PrediXcan, includes all genes; organized genes across, samples down

pred_expr_all <- read.table("frontal_cortex_predicted_expression.txt",header=T,stringsAsFactors=F)
pred_expr_all[pred_expr_all==NaN] <- NA
```

IMPUTED EXPRESSION X RELATIVE IMPORTANCE = WEIGHT  would you expect this gene to be more or less expressed in the phenotype 
Gene list from Seney paper: list of genes weighted for significance
WGCNA: gene list weighted for coexpression as well

```{r}

### step 2: read in gene list

gene_list_all <- read.csv("DLPFC_gene_list.csv",header=T,stringsAsFactors=F)
```

Certainty for expression imputation filter
itierative testing cor model fit -> overfitting -> some tissue/gene pairs were not reliable so they removed it
```{r}
### step 3: read in extra attributes file
### downloaded from PredictDB, tissue-specific

sqlite <- dbDriver("SQLite")
dbname <- "gtex_v7_Brain_Frontal_Cortex_BA9_imputed_europeans_tw_0.5_signif.db"
db = dbConnect(sqlite,dbname)
extra_attr <- dbReadTable(db,"extra")
```

Merge gene list to filter by diff rows 'symbol' 'genename' diff names for genename
remove all genes of interest (full data) from predicted genes

```{r}
### step 4: subset by genes with successfully predicted expression levels
### removing NAN genes and removing those that are not present in both lists 
### list one is weights, list 2 is imputed expression levels of genes confident in imputing reliably 

gene_list_short <- merge(gene_list_all,extra_attr,by.x='SYMBOL',by.y='genename')
pred_expr_short <- pred_expr_all[,names(pred_expr_all) %in% gene_list_short$gene]

```

making mean and standard deviation one on either side so subtraction of mean from SD 
'scale' in stats sense - "Scaling simply means f(x)=cx, câˆˆR, this is, multiplying your observations by a constant c which changes the scale (for example from nanometers to kilometers)"
 
 scales to mean of column
 "scale, with default settings, will calculate the mean and standard deviation of the entire vector (a given gene column), then "scale" each element by those values by subtracting the mean and dividing by the sd. (If you use scale(x, scale=FALSE), it will only subtract the mean but not divide by the std deviation.)"

IIDs: indv id for genetics; SID: indv id for imaging; can't integrate w/o mapping file
```{r}
### step 5: scale predicted expression values and add IIDs 

pred_expr_scaled <- as.data.frame(apply(pred_expr_short,2,function(x){scale(x)})) #apply to each x in "" by column the function scale(x)
row.names(pred_expr_scaled) <- as.character(pred_expr_all$IID)

```

short_gene_names = gene_list_short because the naming thing is weird
```{r}

### step 6: replace ENS IDs with gene names
### if order remains consistent, sum (line 36) will equal number of genes
#renames it

short_gene_names <- data.frame("gene"=names(pred_expr_short))
short_gene_names <- merge(short_gene_names,gene_list_short,by='gene')
sum(names(pred_expr_scaled)==short_gene_names$gene) 
names(pred_expr_scaled) <- short_gene_names$gene
```
divide M/F gene lists
binaries for M/F
```{r}
### step 7: get effect weights

gene_expr_weights_M <- short_gene_names$MD2_DLPFC_M.1
gene_expr_weights_F <- short_gene_names$MD2_DLPFC_F.1



gene_expr_binary_M <- gene_expr_weights_M 
gene_expr_binary_M[gene_expr_binary_M<0] <- -1
gene_expr_binary_M[gene_expr_binary_M>0] <- 1

gene_expr_binary_F <- gene_expr_weights_F 
gene_expr_binary_F[gene_expr_binary_F<0] <- -1
gene_expr_binary_F[gene_expr_binary_F>0] <- 1

```

for gene sum binary and weighted 

A: because it's good for short gene lists when you're doing top x genes, so at that point directionality is more important than effect size 

```{r}
### step 8: compute scores

scores <- data.frame("male.weighted"=numeric(nrow(pred_expr_all)),"female.weighted"=numeric(nrow(pred_expr_all)),"male.unweighted"=numeric(nrow(pred_expr_all)),"female.unweighted"=numeric(nrow(pred_expr_all)))

for (i in 1:nrow(pred_expr_all)){
  scores[i,1]<-sum(pred_expr_scaled[i,]*gene_expr_weights_M,na.rm=T)
  scores[i,2]<-sum(pred_expr_scaled[i,]*gene_expr_weights_F,na.rm=T)
 # scores[i,3]<-sum(pred_expr_scaled[i,]*gene_expr_binary_M,na.rm=T)
 # scores[i,4]<-sum(pred_expr_scaled[i,]*gene_expr_binary_F,na.rm=T)
}

scores <- round(scores,1)
scores$IID <- pred_expr_all$IID
scores <- scores[,c(5,1:4)]
write.csv(scores,'scores_frontal_cortex_predicted_expression.csv')
```